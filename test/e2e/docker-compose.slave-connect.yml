version: "3.9"

services:
  master:
    image: local/tests
    build:
      context: .
      dockerfile: Dockerfile
    stdin_open: true # docker run -i
    tty: true        # docker run -t
    hostname: the_master
    command: sh -c '/opt/tests/test-runner.sh "$TRANSPORT" /opt/tests/$TEST_SET/test-*.sh'
    volumes:
      - ../../dist:/opt/dist:ro
      - .:/opt/tests:ro
    healthcheck:
      test: ["CMD-SHELL", "netstat -an | grep 8080 | grep LISTEN"] 
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 3s
    networks:
      - common
      - master_private

  master-companion:
    image: local/tests
    build:
      context: .
      dockerfile: Dockerfile
    hostname: master-companion
    command: /opt/master-companion-echo.sh
    healthcheck:
      test: ["CMD-SHELL", "netstat -an | grep 9000 | grep LISTEN"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 3s
    networks:
      - master_private

  slave:
    image: local/tests
    build:
      context: .
      dockerfile: Dockerfile
    stdin_open: true # docker run -i
    tty: true        # docker run -t
    depends_on:
      master:
        condition: service_healthy
      master-companion:
        condition: service_healthy
      slave-companion:
        condition: service_healthy
    volumes:
      - ../../dist:/opt/dist:ro
    hostname: the_slave
    command: sh -c 'while true; do sleep 1; /opt/dist/goncat.elf slave connect $TRANSPORT://master:8080; done'
    networks:
      - common
      - slave_private

  slave-companion:
    image: local/tests
    build:
      context: .
      dockerfile: Dockerfile
    hostname: slave-companion
    command: /opt/slave-companion-echo.sh
    healthcheck:
      test: ["CMD-SHELL", "netstat -an | grep 9000 | grep LISTEN"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 3s
    networks:
      - slave_private

networks:
  common:
    driver: bridge
  master_private:
    driver: bridge
    internal: true
  slave_private:
    driver: bridge
    internal: true
